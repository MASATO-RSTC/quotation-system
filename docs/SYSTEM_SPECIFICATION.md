# 見積書作成システム仕様書兼要件定義ドキュメント

## 1. システム概要

本システムは、エンジニア派遣における見積書作成業務を効率化するためのWebアプリケーションです。複雑な単価計算ロジック（時給・月給、各種割増・控除、丸め処理など）を自動化し、データの一元管理と運用ルールの統一を目指します。

## 2. 見積書入力フォーム (`src/app/page.tsx`)

### 2.1. フォームの構成と項目

フォームは以下のセクションで構成される。

- **基本情報**
  - `見積書No.` (自動生成、読み取り専用)
  - `作成日` (日付選択)
  - `有効期限` (日付選択)
- **顧客情報**
  - `企業名` (テキスト入力, 必須)
  - `部署名` (テキスト入力)
  - `担当者氏名` (テキスト入力)
- **スタッフ・契約情報**
  - `スタッフ氏名` (テキスト入力, 必須)
  - `業務内容` (テキストエリア, 必須)
  - `契約種別` (ドロップダウン選択: 「選択してください」, 「時給」, 「月時（上限あり下限あり）」, 「月時（上限あり下限なし）」, 必須)
  - `ご請求単価 (/時)` (数値入力, 必須) - **時給契約選択時のみ表示**
  - `月給単価` (数値入力, 必須) - **月時契約選択時のみ表示**
  - `上限時間 (h)` (数値入力, 必須) - **月時（上限あり）契約選択時のみ表示**
  - `下限時間 (h)` (数値入力, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `超過単価の算出基準` (ドロップダウン選択: 上限割, 下限割, 中央割, 任意時間割, 必須) - **月時（上限あり）契約選択時のみ表示**
  - `任意時間 (h)` (数値入力, 必須) - **超過単価の算出基準が「任意時間割」選択時のみ表示**
  - `控除単価の算出基準` (ドロップダウン選択: 上限割, 下限割, 中央割, 任意時間割, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `任意時間 (h)` (数値入力, 必須) - **控除単価の算出基準が「任意時間割」選択時のみ表示**
  - `割増係数 (超過単価のみ)` (数値入力) - **月時（上限あり）契約選択時のみ表示**
  - `契約開始日` (日付選択, 必須)
  - `契約終了日` (日付選択, 必須)
- **割増率設定**
  - `普通残業` (数値入力) - **時給契約選択時のみ表示**
  - `深夜手当` (数値入力)
  - `法定休日出勤` (数値入力)
  - `法定外休日出勤` (数値入力)
  - `60時間超過` (数値入力)
- **丸め・精算設定** (全て必須)
  - `金額丸め単位` (ドロップダウン選択: 1, 10, 100, 1000)
  - `丸め方法` (ドロップダウン選択: 切り捨て, 切り上げ, 四捨五入)
  - `時間精算単位` (ドロップダウン選択: 1, 3, 5, 10, 15, 30, 45, 60)
  - `精算丸め` (ドロップダウン選択: 切り捨て, 切り上げ, 四捨五入)
- **計算結果** (自動計算・表示専用)
  - **時給契約選択時**:
    - `普通残業単価`
    - `深夜手当単価`
    - `法定休日出勤単価`
    - `法定外休日出勤単価`
    - `60時間超過単価`
  - **月時契約選択時**:
    - `超過単価`
    - `控除単価` - **月時（上限あり下限あり）選択時のみ表示**
    - `割増後超過単価` (割増係数が設定されている場合)
- **特記事項**
  - `特記事項` (テキストエリア)
- **発行元**
  - `発行元` (テキストエリア)

### 2.2. 初期値と動的挙動

- **日付関連**:
  - `作成日`: 現在の日付。
  - `有効期限`: 作成日の1ヶ月後。
  - `契約開始日`: 当月の1日。
  - `契約終了日`: 当月の2ヶ月後の末日。
- **単価・割増率**:
  - `ご請求単価`/`月給単価`: `0` が設定されている。
  - `割増率`: それぞれ標準的な値 (1.25, 0.25など) が設定されている。
  - `割増率`の入力欄からフォーカスが外れた際、値が空白の場合は自動的に `0` が入力される。
- **発行元情報**: 株式会社リツアンSTCの連絡先が設定されている。
- **計算結果**: `ご請求単価`/`月給単価`や`割増率`、`丸め・精算設定`を変更すると、リアルタイムで計算結果が更新される。計算結果が0円の場合は `-` と表示される。
- **PDF生成ボタン**: ボタンクリック後、PDFの生成が完了するまで「生成中...」と表示され、ボタンは無効化される。
- **契約種別**: 「選択してください」が初期値。選択された契約種別に応じて、関連する入力項目が動的に表示/非表示される。
- **月時契約**: 月時契約選択時は、時給の「普通残業」の割増率設定が非表示になり、月時専用の設定項目が表示される。

## 3. 計算ロジック (`src/utils/calculations.ts`)

### 3.1. 時給契約の計算
- `ご請求単価`と各種`割増率`を基に、それぞれの割増単価を計算する。
- 計算された金額は、フォームで指定された`金額丸め単位`と`丸め方法`に基づいて端数処理される。

### 3.2. 月時契約の計算
- `月給単価`、`上限時間`、`下限時間`（該当する場合）を基に、超過単価と控除単価を計算する。
- **超過単価の算出方法**:
  - 上限割: `月給単価 ÷ 上限時間`
  - 下限割: `月給単価 ÷ 下限時間`
  - 中央割: `月給単価 ÷ ((上限時間 + 下限時間) ÷ 2)`
  - 任意時間割: `月給単価 ÷ 任意時間`
- **控除単価の算出方法**（月時（上限あり下限あり）のみ）:
  - 上限割: `月給単価 ÷ 上限時間`
  - 下限割: `月給単価 ÷ 下限時間`
  - 中央割: `月給単価 ÷ ((上限時間 + 下限時間) ÷ 2)`
  - 任意時間割: `月給単価 ÷ 任意時間`
- **割増後超過単価**: `超過単価 × 割増係数` (割増係数が設定されている場合のみ)
- 計算された金額は、フォームで指定された`金額丸め単位`と`丸め方法`に基づいて端数処理される。

## 4. PDF出力 (`src/utils/generateQuotationPdf.ts`)

### 4.1. 全体設定

- **ファイル名**: `御見積書.pdf`
- **フォント**: `Noto Sans JP` を使用。

### 4.2. レイアウトとコンテンツ

1.  **ヘッダー**: ロゴと「御見積書」タイトルを配置。
2.  **情報ブロック**: 見積番号、作成日、有効期限、発行元情報を配置。
3.  **宛先ブロック**: 顧客情報を表示。
4.  **挨拶**: 「下記の通り御見積申し上げます」と表示。
5.  **明細テーブル**:
    - ヘッダーは「項目」「内容」。
    - **時給契約**: ご請求単価、各種割増単価を表示。
    - **月時（上限あり下限あり）契約**: 月給単価、時間幅（例: 140h 〜 180h）、超過単価、控除単価を表示。超過単価は、割増係数が設定されている場合、割増後の金額が表示される。
    - **月時（上限あり下限なし）契約**: 月給単価、時間幅（例: 下限なし〜180h）、超過単価を表示。超過単価は、割増係数が設定されている場合、割増後の金額が表示される。
6.  **特記事項ブロック**: 精算情報や手入力の特記事項、および月時契約の場合は単価の計算式を表示。

## 5. UI/UXに関する考慮事項

*   **動的なフォーム表示:** 選択された「契約種別」に応じて、関連する入力項目のみが表示されるようにします。
*   **入力バリデーション:** 各入力項目に対して適切なバリデーションを実装します。
*   **リアルタイム計算結果表示:** 入力値の変更に応じて、計算結果がリアルタイムで更新・表示されるようにします。

## 6. 契約種別ごとの詳細仕様

### 6.1. 時給

*   **計算ロジック:**
    *   基本となる請求単価に対して、各種割増率を掛けて割増単価を算出します。

### 6.2. 月時契約

#### 6.2.1. 月時（上限あり下限あり）

*   **概要:** 月給制で、月間の労働時間に上限と下限を設けた契約形態。
*   **入力項目:**
    *   `月給単価`, `上限時間 (h)`, `下限時間 (h)`, `超過単価の算出基準`, `控除単価の算出基準`, `割増係数`
*   **計算ロジック:**
    *   超過単価と控除単価は、指定された基準時間で月給単価を割って算出します。
*   **算出基準の選択肢:**
    *   超過単価: 上限割, 下限割, 中央割, 任意時間割
    *   控除単価: 上限割, 下限割, 中央割, 任意時間割

#### 6.2.2. 月時（上限あり下限なし）

*   **概要:** 月給制で、月間の労働時間に上限のみを設けた契約形態。下限時間はなく、控除の概念もありません。
*   **入力項目:**
    *   `月給単価`, `上限時間 (h)`, `超過単価の算出基準`, `割増係数`
    *   `下限時間 (h)` と `控除単価の算出基準` に関連する項目は非表示になります。
*   **計算ロジック:**
    *   超過単価のみを計算します。控除単価は計算されません。
*   **算出基準の選択肢:**
    *   超過単価: 上限割, 任意時間割
      *   下限時間がないため、「下限割」「中央割」は選択肢に表示されません。

*   **共通の割増率設定:**
    *   全ての月時契約において、以下の割増率を任意で設定でき、計算結果に反映されます（デフォルトは空白）。
        *   深夜手当 (x0.25)
        *   法定休日出勤 (x1.35)
        *   法定外休日出勤 (x1.25)
        *   60時間超過 (x1.50)
