# 見積書作成システム仕様書兼要件定義ドキュメント

## 1. システム概要

本システムは、エンジニア派遣における見積書作成業務を効率化するためのWebアプリケーションです。複雑な単価計算ロジック（時給・月給、各種割増・控除、丸め処理など）を自動化し、データの一元管理と運用ルールの統一を目指します。

## 2. 見積書入力フォーム (`src/app/page.tsx`)

### 2.1. フォームの構成と項目

フォームは以下のセクションで構成される。

- **基本情報**
  - `見積書No.` (自動生成、読み取り専用)
  - `作成日` (日付選択)
  - `有効期限` (日付選択)
- **顧客情報**
  - `企業名` (テキスト入力, 必須)
  - `部署名` (テキスト入力)
  - `担当者氏名` (テキスト入力)
- **スタッフ・契約情報**
  - `スタッフ氏名` (テキスト入力, 必須)
  - `業務内容` (テキストエリア, 必須)
  - `契約種別` (ドロップダウン選択: 「選択してください」, 「時給」, 「月時（上限あり下限あり）」, 必須)
  - `ご請求単価 (/時)` (数値入力, 必須) - **時給契約選択時のみ表示**
  - `月給単価` (数値入力, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `上限時間 (h)` (数値入力, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `下限時間 (h)` (数値入力, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `超過単価の算出基準` (ドロップダウン選択: 上限割, 下限割, 中央割, 任意時間割, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `任意時間 (h)` (数値入力, 必須) - **超過単価の算出基準が「任意時間割」選択時のみ表示**
  - `控除単価の算出基準` (ドロップダウン選択: 上限割, 下限割, 中央割, 任意時間割, 必須) - **月時（上限あり下限あり）選択時のみ表示**
  - `任意時間 (h)` (数値入力, 必須) - **控除単価の算出基準が「任意時間割」選択時のみ表示**
  - `割増係数 (超過単価のみ)` (数値入力) - **月時（上限あり下限あり）選択時のみ表示**
  - `契約開始日` (日付選択, 必須)
  - `契約終了日` (日付選択, 必須)
- **割増率設定** - **時給契約選択時のみ表示**
  - `普通残業` (数値入力)
  - `深夜手当` (数値入力)
  - `法定休日出勤` (数値入力)
  - `法定外休日出勤` (数値入力)
  - `60時間超過` (数値入力)
- **丸め・精算設定** (全て必須)
  - `金額丸め単位` (ドロップダウン選択: 1, 10, 100, 1000)
  - `丸め方法` (ドロップダウン選択: 切り捨て, 切り上げ, 四捨五入)
  - `時間精算単位` (ドロップダウン選択: 1, 3, 5, 10, 15, 30, 45, 60)
  - `精算丸め` (ドロップダウン選択: 切り捨て, 切り上げ, 四捨五入)
- **計算結果** (自動計算・表示専用)
  - **時給契約選択時**:
    - `普通残業単価`
    - `深夜手当単価`
    - `法定休日出勤単価`
    - `法定外休日出勤単価`
    - `60時間超過単価`
  - **月時（上限あり下限あり）選択時**:
    - `超過単価`
    - `控除単価`
    - `割増後超過単価` (割増係数が設定されている場合)
- **特記事項**
  - `特記事項` (テキストエリア)
- **発行元**
  - `発行元` (テキストエリア)

### 2.2. 初期値と動的挙動

- **日付関連**:
  - `作成日`: 現在の日付。
  - `有効期限`: 作成日の1ヶ月後。
  - `契約開始日`: 当月の1日。
  - `契約終了日`: 当月の2ヶ月後の末日。
- **単価・割増率**:
  - `ご請求単価`/`月給単価`: `0` が設定されている。
  - `割増率`: それぞれ標準的な値 (1.25, 0.25など) が設定されている。
  - `割増率`の入力欄からフォーカスが外れた際、値が空白の場合は自動的に `0` が入力される。
- **発行元情報**: 株式会社リツアンSTCの連絡先が設定されている。
- **計算結果**: `ご請求単価`/`月給単価`や`割増率`、`丸め・精算設定`を変更すると、リアルタイムで計算結果が更新される。計算結果が0円の場合は `-` と表示される。
- **PDF生成ボタン**: ボタンクリック後、PDFの生成が完了するまで「生成中...」と表示され、ボタンは無効化される。
- **契約種別**: 「選択してください」が初期値。選択された契約種別に応じて、関連する入力項目が動的に表示される。
- **月時契約**: 月時（上限あり下限あり）選択時は、時給の割増率設定が非表示になり、月時専用の設定項目が表示される。

## 3. 計算ロジック (`src/utils/calculations.ts`)

### 3.1. 時給契約の計算
- `ご請求単価`と各種`割増率`を基に、それぞれの割増単価を計算する。
- 計算された金額は、フォームで指定された`金額丸め単位`と`丸め方法`に基づいて端数処理される。
- `hourlyCalculatedRates` は、`ご請求単価`、`金額丸め単位`、`丸め方法`が未入力（0または空白）の場合でも計算結果を返す。

### 3.2. 月時（上限あり下限あり）契約の計算
- `月給単価`、`上限時間`、`下限時間`を基に、超過単価と控除単価を計算する。
- **超過単価の算出方法**:
  - 上限割: `月給単価 ÷ 上限時間`
  - 下限割: `月給単価 ÷ 下限時間`
  - 中央割: `月給単価 ÷ ((上限時間 + 下限時間) ÷ 2)`
  - 任意時間割: `月給単価 ÷ 任意時間`
- **控除単価の算出方法**:
  - 上限割: `月給単価 ÷ 上限時間`
  - 下限割: `月給単価 ÷ 下限時間`
  - 中央割: `月給単価 ÷ ((上限時間 + 下限時間) ÷ 2)`
  - 任意時間割: `月給単価 ÷ 任意時間`
- **割増後超過単価**: `超過単価 × 割増係数` (割増係数が設定されている場合のみ)
- 計算された金額は、フォームで指定された`金額丸め単位`と`丸め方法`に基づいて端数処理される。

## 4. PDF出力 (`src/utils/generateQuotationPdf.ts`)

### 4.1. 全体設定

- **ファイル名**: `御見積書.pdf`
- **フォント**: `Noto Sans JP` を使用。パフォーマンス低下を防ぐため、PDF生成時にフォントデータを動的に読み込む。

### 4.2. レイアウトとコンテンツ

1.  **ヘッダー**:
    - 中央に「御見積書」というタイトルを配置。
    - 左上にロゴ画像 (`ritsuan_logo.png`) を配置。
2.  **情報ブロック**:
    - **左側**: `見積番号`, `作成日`, `有効期限` を表示。
    - **右側**: 「【発行元】」というタイトルを付け、その下に発行元情報を表示。行間は左側の情報ブロックと揃える。発行元情報の右側には、文字と重ならないように少し小さくした印鑑画像 (`inkan.png`) を配置。
3.  **宛先ブロック**:
    - `▪御社名： {企業名} 御中` の形式で表示。
    - `部署名`が入力されている場合のみ、`▪部署名： {部署名}` を表示。
    - `担当者氏名`が入力されている場合のみ、`▪ご担当者様： {担当者氏名} 様` を表示。
4.  **挨拶**:
    - 中央に「下記の通り御見積申し上げます」と表示。
5.  **明細テーブル**:
    - テーブルの上に「【御見積詳細】」というタイトルを配置。
    - ヘッダーは「項目」「内容」。
    - 本体には、スタッフ名、契約期間、業務内容、各種単価などを表示。単価が0の場合は `-` と表示。
    - **時給契約**: ご請求単価、各種割増単価を表示。
    - **月時（上限あり下限あり）契約**: 月給単価、上限時間、下限時間、超過単価、控除単価、割増後超過単価（設定時）を表示。
    - 「内容」列のテキストは中央揃え。
6.  **特記事項ブロック**:
    - 「【特記事項】」というタイトルを配置。
    - グレーの枠線で囲み、内部に余白を設ける。
    - フォームで選択された設定に基づき、「精算時間はXX分XX。精算金額はXX円XX。」という一文を自動生成し、その下に手入力された特記事項を表示。

## 5. UI/UXに関する考慮事項

*   **動的なフォーム表示:** 選択された「契約種別」に応じて、関連する入力項目のみが表示されるようにします。
*   **入力バリデーション:** 各入力項目に対して適切なバリデーションを実装します。
*   **リアルタイム計算結果表示:** 入力値の変更に応じて、計算結果がリアルタイムで更新・表示されるようにします。

## 6. 契約種別ごとの詳細仕様

### 6.1. 時給

*   **計算ロジック:**
    *   基本となる請求単価に対して、以下の割増率を掛けて各種割増単価を算出します。
        *   普通残業: 1.25倍
        *   深夜手当: 0.25倍
        *   法定休日出勤: 1.35倍
        *   法定外休日出勤: 1.25倍
        *   60時間超過: 1.50倍
    *   **割増率の調整:** 上記の各割増率は、ユーザーが任意で調整可能です。

### 6.2. 月時（上限あり下限あり）

*   **概要:** 月給制で、月間の労働時間に上限と下限を設けた契約形態。
*   **入力項目:**
    *   `月給単価`: 月間の基本給与額
    *   `上限時間 (h)`: 月間の最大労働時間
    *   `下限時間 (h)`: 月間の最小労働時間
    *   `超過単価の算出基準`: 上限時間を超過した場合の単価計算方法
    *   `控除単価の算出基準`: 下限時間を下回った場合の単価計算方法
    *   `割増係数`: 超過単価に適用する割増率（任意）
*   **計算ロジック:**
    *   超過単価: 月給単価を指定された基準時間で割って算出
    *   控除単価: 月給単価を指定された基準時間で割って算出
    *   割増後超過単価: 超過単価に割増係数を掛けて算出（設定時のみ）
*   **算出基準の選択肢:**
    *   上限割: 上限時間で割る
    *   下限割: 下限時間で割る
    *   中央割: (上限時間 + 下限時間) ÷ 2 で割る
    *   任意時間割: ユーザーが指定した時間で割る
*   **割増率の設定:** 月時契約の場合、以下の割増率を任意で設定することができ、計算結果に反映される（デフォルトは空白）。
    *   深夜手当 (x0.25)
    *   法定休日出勤 (x1.35)
    *   法定外休日出勤 (x1.25)
    *   60時間超過 (x1.50)
